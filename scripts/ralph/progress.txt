# Ralph Progress Log
Started: 2026-01-10

## Phase 1 Status: COMPLETE
All 8 user stories from prd.json completed and merged to main.

## Phase 2: Server Deployment (prd-server.json)
See prd-server.json for 8 new user stories targeting:
- Ubuntu 22.04 distros working
- NixOS as distribution option
- SSH/proxy/API server hosting
- One-click service templates

## Phase 3: Multi-Process Support
See prd.json for 6 MP-* stories enabling concurrent process execution.

---

## [2026-01-19] - MP-005
- **What was implemented**: Added stdin support for interactive command execution
- **Files changed**:
  - `app/src/main/java/com/udroid/app/nativebridge/NativeBridge.kt`:
    - Added `launchProotInteractive()` method that accepts `stdinInput: String?` parameter
    - Writes stdin input to process's outputStream via a separate thread before waiting for completion
    - Uses `bufferedWriter().use { }` to properly close the stream after writing
    - Reuses existing CountDownLatch-based stdout/stderr reader pattern from `launchProot()`
  - `app/src/main/java/com/udroid/app/session/UbuntuSession.kt`:
    - Added `execInteractive()` method to the interface with KDoc documentation
    - Method accepts `command`, `stdinInput`, and optional `timeoutSeconds` parameters
    - Returns `Result<ProcessResult>` consistent with existing `exec()` method
  - `app/src/main/java/com/udroid/app/session/UbuntuSessionManagerImpl.kt`:
    - Implemented `execInteractive()` in `UbuntuSessionImpl`
    - Delegates to `nativeBridge.launchProotInteractive()` with same env vars as `exec()`
- **Acceptance criteria verification**:
  - ✓ New execInteractive() method accepts stdin input
  - ✓ Can pipe input to running proot process (via process.outputStream.bufferedWriter())
  - ✓ Returns ProcessResult with stdout/stderr as before
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - `process.outputStream` is the stdin pipe to the subprocess (confusingly named from process perspective)
  - Must write stdin in a separate thread to avoid deadlock if process buffer fills before we read stdout
  - `bufferedWriter().use { }` ensures the stream is closed after writing, which signals EOF to the subprocess
  - The `stdinInput` parameter can be null for commands that don't need stdin (behaves like regular `launchProot`)

---

## [2026-01-19] - MP-004
- **What was implemented**: Added configurable timeout support for long-running operations
- **Files changed**:
  - `app/src/main/java/com/udroid/app/nativebridge/NativeBridge.kt`:
    - Changed default timeout from 30s to 300s (5 minutes)
    - Added KDoc documentation for `launchProot()` explaining timeout behavior
    - Implemented `timeoutSeconds <= 0` handling: uses `process.waitFor()` (no timeout) instead of `process.waitFor(timeout, TimeUnit.SECONDS)`
    - Refactored wait logic to branch based on timeout value
  - `app/src/main/java/com/udroid/app/session/UbuntuSession.kt`:
    - Changed default timeout from 60s to 300s (5 minutes)
    - Added KDoc documentation for `exec()` explaining timeout behavior
- **Acceptance criteria verification**:
  - ✓ exec() accepts optional timeout parameter with default 300s (was 60s)
  - ✓ launchProot respects configurable timeout (already did, now with better default)
  - ✓ Timeout of 0 means no timeout (wait indefinitely) - implemented via `timeoutSeconds <= 0` check
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - `process.waitFor()` (no args) blocks indefinitely until process exits - perfect for long-running tasks
  - `process.waitFor(timeout, TimeUnit)` returns boolean (completed or not) and requires explicit timeout handling
  - Using `<= 0` check allows both 0 and negative values to mean "no timeout" which is defensive
  - The default timeout should be generous (300s) for Claude Code tasks which can run long AI operations

---

## [2026-01-19] - MP-003
- **What was implemented**: Fixed stream reader race condition in launchProot
- **Files changed**:
  - `app/src/main/java/com/udroid/app/nativebridge/NativeBridge.kt`:
    - Added `CountDownLatch` import for proper thread synchronization
    - Replaced `join(500)` with `CountDownLatch(2)` - each reader thread calls `countDown()` in finally block
    - Added `use { }` blocks to ensure streams are properly closed
    - Added `synchronized(stdoutBuilder)` / `synchronized(stderrBuilder)` when appending lines
    - Used `readersLatch.await(5, TimeUnit.SECONDS)` to wait for readers with reasonable timeout
    - Added interrupt fallback if readers don't complete within 5 seconds
    - Synchronized final read of StringBuilder contents to ensure visibility
- **Acceptance criteria verification**:
  - ✓ stdout/stderr reader threads complete before returning result (via CountDownLatch.await())
  - ✓ Fast commands (<100ms) capture full output (readers wait until EOF, not arbitrary 500ms)
  - ✓ Use proper thread synchronization instead of join(500) (CountDownLatch + synchronized blocks)
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - `join(500)` is a race condition - it gives up after 500ms regardless of whether the reader is done
  - `CountDownLatch` is the right primitive when you need to wait for N threads to complete a phase
  - Reader threads naturally finish when the stream reaches EOF (process exit), so waiting on latch works well
  - For timeout/kill scenario, `destroyForcibly()` closes streams causing readers to get IOException and exit
  - Using `use { }` blocks ensures BufferedReader is closed even on exception (resource management)
  - `synchronized` on StringBuilder is needed because multiple threads access it (append vs toString)

---

## [2026-01-19] - MP-002
- **What was implemented**: Added actual OS PID retrieval from proot processes
- **Files changed**:
  - `app/src/main/java/com/udroid/app/nativebridge/NativeBridge.kt`:
    - Added `ProotProcessHandle` data class containing sessionId, pid, and isAlive status
    - Added `getProcessHandle(sessionId)` method returning `ProotProcessHandle?` for a session
    - Added `getPid(sessionId)` method returning the actual OS PID (Long) for a session
    - Added private `getProcessPid(process)` helper using reflection to extract PID from Android's UNIXProcess
  - `app/src/main/java/com/udroid/app/session/UbuntuSession.kt`:
    - Added `suspend fun getPid(): Long` method to `UbuntuSession` interface
  - `app/src/main/java/com/udroid/app/session/UbuntuSessionManagerImpl.kt`:
    - Implemented `getPid()` in `UbuntuSessionImpl` - delegates to `nativeBridge.getPid(id)`
    - Removed obsolete `processPid = System.currentTimeMillis()` timestamp assignment
- **Acceptance criteria verification**:
  - ✓ launchProot returns ProcessHandle (via `getProcessHandle()`) or wrapper with real PID
  - ✓ UbuntuSessionImpl stores actual PID instead of timestamp (removed timestamp, now uses live query)
  - ✓ getPid(sessionId) method returns real process ID (`NativeBridge.getPid()` + `UbuntuSession.getPid()`)
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - Android's JDK doesn't include `ProcessHandle` from Java 9+ - `process.toHandle()` doesn't exist
  - Must use reflection to access the private `pid` field on Android's `java.lang.UNIXProcess`
  - The field name is simply `pid` (int) on Android's UNIXProcess - accessible via `getDeclaredField("pid")`
  - Live PID query (calling `nativeBridge.getPid()` when needed) is preferred over storing a stale value

---

## [2026-01-19] - MP-001
- **What was implemented**: Refactored NativeBridge to track multiple processes via Map<String, Process>
- **Files changed**:
  - `app/src/main/java/com/udroid/app/nativebridge/NativeBridge.kt`:
    - Replaced single `prootProcess: Process?` field with `processMap: MutableMap<String, Process>`
    - Added `sessionId: String` parameter to `launchProot()` - stores process in map after start, removes on completion
    - Updated `killProot(sessionId: String, signal: Int)` - looks up and removes process from map by sessionId
    - Updated `isProotRunning(sessionId: String)` - checks if process exists and is alive in map
    - Updated `waitForProot(sessionId: String, timeoutMs: Long)` - waits for specific session's process
    - Updated `getProotStdout(sessionId: String)` and `getProotStderr(sessionId: String)` - read from specific session's streams
    - Added `synchronized(processMap)` blocks for thread-safe access
  - `app/src/main/java/com/udroid/app/session/UbuntuSessionManagerImpl.kt`:
    - Updated all `nativeBridge.launchProot()` calls to pass `sessionId = id`
    - Updated `nativeBridge.killProot()` call to pass session `id` instead of pid
- **Acceptance criteria verification**:
  - ✓ NativeBridge uses Map<String, Process> instead of single prootProcess field
  - ✓ launchProot accepts sessionId parameter and stores process in map
  - ✓ killProot accepts sessionId to kill specific process
  - ✓ isProotRunning accepts sessionId to check specific process
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - Use `synchronized(processMap)` for thread-safe access to the mutable map since coroutines may access from different threads
  - The session id is a natural key for process tracking since each session maps to one proot instance
  - Process cleanup must happen in both success path (after waitFor completes) and timeout path (after destroyForcibly)
  - The old `processPid: Long?` field in UbuntuSessionImpl is now technically unused (still storing timestamp) - MP-002 will address returning actual OS PIDs

---

## [2026-01-10] - SRV-001 (In Progress)
- **What was implemented**: Added Ubuntu 22.04 rootfs download support
- **Files changed**:
  - `app/src/main/java/com/udroid/app/model/DistroVariant.kt` - Added `downloadUrl` field with linuxcontainers.org URLs for Ubuntu variants
  - `app/src/main/java/com/udroid/app/service/RootfsDownloadService.kt` - Updated to use distro.downloadUrl as fallback if no URL provided in intent
  - `app/src/main/java/com/udroid/app/rootfs/RootfsManager.kt` - Added XZ decompression support for .tar.xz files, smart cache file extension detection
  - `app/build.gradle.kts` - Added xz-java library dependency for XZ decompression
  - `.claude/plugins/android-testing/skills/codex-subagent.md` - New skill documenting Codex CLI subagent pattern
- **Acceptance criteria status**:
  - ✓ Ubuntu XFCE4/MATE/GNOME variants have download URLs from linuxcontainers.org CDN
  - ✓ Rootfs extracts with proper symlinks preserved (implemented in Phase 1)
  - ⏳ PRoot can launch /bin/bash in Ubuntu rootfs - NEEDS DEVICE TESTING
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Next steps**: Test actual Ubuntu download on device to verify full functionality

---

## [2026-01-10] - PRoot Fixes (Post US-008)
- **What was implemented**: Fixed PRoot to actually work on Android device
- **Files changed**:
  - `app/src/main/AndroidManifest.xml` - Added `extractNativeLibs="true"` for Android 10+
  - `app/build.gradle.kts` - Added `jniLibs.useLegacyPackaging = true`
  - `app/src/main/java/com/udroid/app/nativebridge/NativeBridge.kt` - Copy libtalloc.so to versioned libtalloc.so.2, update LD_LIBRARY_PATH
  - `app/src/main/java/com/udroid/app/rootfs/RootfsManager.kt` - Create symlinks during extraction (required for busybox)
- **Test result**: PRoot test successful with Alpine Linux on device
- **Learnings:**
  - Android 10+ doesn't extract native libs by default - need `extractNativeLibs="true"`
  - PRoot expects `libtalloc.so.2` (versioned) but Android bundles as `libtalloc.so`
  - Alpine rootfs uses busybox symlinks (/bin/sh -> busybox) - must create during extraction
  - `Files.createSymbolicLink()` works in Android app-private directories

---

## Codebase Patterns
- Session lifecycle transitions must be persisted via `SessionRepository.updateSessionState(sessionId, ...)`.
- Session persistence conversions live in `SessionRepository.kt` (`SessionStateData.toDomain()` and `SessionState.toData()`).
- Avoid throwing across UI/service boundaries; prefer `Result`.

## Key Files
- app/src/main/java/com/udroid/app/MainActivity.kt
- app/src/main/java/com/udroid/app/service/UbuntuSessionService.kt
- app/src/main/java/com/udroid/app/service/RootfsDownloadService.kt
- app/src/main/java/com/udroid/app/session/UbuntuSession.kt
- app/src/main/java/com/udroid/app/session/UbuntuSessionManagerImpl.kt
- app/src/main/java/com/udroid/app/storage/SessionRepository.kt
- app/src/main/java/com/udroid/app/devbox/ (new devbox feature)
- app/src/main/java/com/udroid/app/ui/services/ (new services UI)

- Devbox share state persistence follows the same pattern: `DevServiceRepository` for service/share data, `SessionRepository` for session data. They use separate DataStores ("dev_services" vs "sessions") to avoid interference.
- Domain/persistence model separation: `DevboxShareState` (domain) + `ShareStateData` (persistence) with `toDomain()`/`toData()` conversion functions.

---

## [2026-01-10] - US-008
- **What was implemented**: Added UI affordance to show shareable URL + QR code on DesktopScreen
- **Files changed**:
  - `app/src/main/java/com/udroid/app/ui/desktop/DesktopScreen.kt` - Added `ShareDialog` composable with QR code generation using ZXing, clipboard copy functionality, and close button; added Share icon to `TopBar`; added `generateQrCode()` helper function
  - `app/src/main/java/com/udroid/app/ui/desktop/DesktopViewModel.kt` - Added `ShareUiState` data class, `shareUiState` StateFlow, `toggleSharePanel()`/`hideSharePanel()` methods, and `generateStubShareUrl()` function
- **Acceptance criteria verification**:
  - ✓ DesktopScreen shows a share section gated behind a button/toggle (Share icon in TopBar, only visible when `isRunning == true`)
  - ✓ A QR code can be generated for the stub URL (ZXing `QRCodeWriter` generates Bitmap from stub URL)
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - ZXing `QRCodeWriter.encode()` returns a `BitMatrix` which must be converted to Android `Bitmap` pixel-by-pixel
  - Using `remember(shareUrl)` in Compose ensures QR code is only regenerated when the URL changes
  - OneDrive sync can cause file locking issues with Gradle builds in WSL; use `--no-parallel --max-workers=1` as workaround
---

## [2026-01-10] - US-007
- **What was implemented**: Verified that devbox sharing data model already exists and compiles successfully
- **Files reviewed**:
  - `app/src/main/java/com/udroid/app/devbox/DevService.kt:124-140` - Contains `DevboxShareState` domain model and `ShareProtocol` enum
  - `app/src/main/java/com/udroid/app/storage/DevServiceRepository.kt:112-250` - Contains `ShareStateData` persistence model with full CRUD operations and conversion functions
- **Acceptance criteria verification**:
  - ✓ A persisted model exists for devbox share state (`ShareStateData` in `DevServiceRepository.kt`)
  - ✓ No changes break existing session persistence (uses separate `serviceDataStore` with name "dev_services")
  - ✓ `./gradlew :app:assembleDebug` succeeds
- **Learnings:**
  - The devbox feature uses a completely separate DataStore instance (`dev_services`) from session persistence (`sessions`), ensuring no interference.
  - Model already follows established pattern: domain class (`DevboxShareState`) + serializable persistence class (`ShareStateData`) + bidirectional conversion functions.
---

## [2026-01-10] - US-001 through US-006
- **What was implemented**: Fixed all compilation errors to achieve a successful `assembleDebug` build
- **Files changed**:
  - `app/src/main/java/com/udroid/app/devbox/DevServiceManager.kt` - Added missing imports (`Context`, `ApplicationContext`)
  - `app/src/main/java/com/udroid/app/devbox/NetworkUtils.kt` - Fixed non-exhaustive `when` expression by switching from object equality to `template.id` string matching with `else` branch
  - `app/src/main/java/com/udroid/app/ui/services/ServicesViewModel.kt` - Added missing StateFlow/SharedFlow declarations (`_sessionState`, `_services`, `_logs`, `_deviceIp`, `_isLoading`, `_toastMessage`, `_error`)
  - `app/src/main/java/com/udroid/app/ui/services/ServicesScreen.kt` - Fixed Composable context issue by replacing `item { forEach { } }` pattern with proper `items(list)` LazyColumn usage
  - `gradle.properties` - Updated JAVA_HOME to Linux JDK path
  - `local.properties` - Updated SDK path to Linux Android SDK

- **Learnings:**
  - `ServiceTemplate` is a data class, not an enum. When comparing data class instances with `when`, use a property like `.id` and include an `else` branch for exhaustiveness.
  - In Compose LazyColumn, `forEach` inside an `item { }` block doesn't properly handle @Composable functions. Use `items(list)` instead for proper composable scope.
  - Hilt `@ApplicationContext` qualifier requires importing both `android.content.Context` and `dagger.hilt.android.qualifiers.ApplicationContext`.
  - StateFlow/SharedFlow variables must be declared in ViewModel before they can be assigned values.
---
